{% extends "base.html" %}

{% block title %}Manage Licenses - Licensing Roadmap
<!-- Set Goal Modal -->
<div class="modal fade" id="setGoalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set Next License Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/team/set-goal/{{ holder.user_id }}">
                <div class="modal-body">
                    <p class="text-muted small">Choose the next state for <strong>{{ holder.name }}</strong> to pursue a license in.</p>
                    <div class="mb-3">
                        <label class="form-label">Target State</label>
                        <select class="form-select" name="target_state" required>
                            <option value="">Select a state...</option>
                            {% set licensed_states = licenses|selectattr('status', 'equalto', 'licensed')|map(attribute='jurisdiction_abbr')|list %}
                            {% for abbr in ['AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA', 'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD', 'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ', 'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC', 'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'] %}
                            {% if abbr not in licensed_states %}
                            <option value="{{ abbr }}" {% if holder.next_target_state == abbr %}selected{% endif %}>
                                {{ abbr }}
                            </option>
                            {% endif %}
                            {% endfor %}
                        </select>
                        <small class="text-muted">Only showing states where not yet licensed</small>
                    </div>
                </div>
                <div class="modal-footer">
                    {% if holder.next_target_state %}
                    <button type="button" class="btn btn-outline-danger" onclick="clearGoal()">Clear Goal</button>
                    {% endif %}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Goal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.goal-display {
    text-align: center;
    padding: 1rem;
    background: #f0f9ff;
    border: 2px solid #3b82f6;
    border-radius: 8px;
}

.goal-state {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e40af;
    font-family: 'Courier New', monospace;
}

.goal-label {
    margin-top: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
</style>

<script>
function clearGoal() {
    if (confirm('Clear the license goal for {{ holder.name }}?')) {
        fetch('/team/clear-goal/{{ holder.user_id }}', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error clearing goal');
            }
        });
    }
}
</script>

{% endblock %}

{% block content %}
<div class="settings-page">
    <div class="container-fluid px-4 py-3">
        <div class="row">
            <div class="col-12">
                <!-- Compact Header -->
                <div class="page-header-compact">
                    <h3>üìú Manage Licenses</h3>
                    <a href="/settings/add-license" class="btn btn-sm btn-success">+ Add New License</a>
                </div>

                <div class="row g-3">
                    <!-- Left: Profile Quick Stats (Compact Card) -->
                    <div class="col-lg-3">
                        <div class="compact-stats-card">
                            <div class="compact-stat-row">
                                <span class="compact-stat-label">License Holder</span>
                                <span class="compact-stat-value">{{ holder.name }}</span>
                            </div>
                            <div class="compact-stat-row">
                                <span class="compact-stat-label">Role</span>
                                <span class="compact-stat-value">{{ holder.role }}</span>
                            </div>
                            <div class="compact-stat-divider"></div>
                            <div class="compact-stat-grid">
                                <div class="compact-stat-box">
                                    <div class="compact-stat-number text-success">{{ holder.total_licenses }}</div>
                                    <div class="compact-stat-text">Licenses</div>
                                </div>
                                <div class="compact-stat-box">
                                    <div class="compact-stat-number text-primary">{{ holder.total_certificates }}</div>
                                    <div class="compact-stat-text">Certificates</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Next License Goal (Director Only) -->
                        {% if is_director %}
                        <div class="compact-stats-card mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">üéØ Next License Goal</h6>
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#setGoalModal">
                                    {% if holder.next_target_state %}Edit{% else %}Set Goal{% endif %}
                                </button>
                            </div>
                            {% if holder.next_target_state %}
                                {% set goal_state = holder.next_target_state %}
                                {% set is_licensed = licenses|selectattr('jurisdiction_abbr', 'equalto', goal_state)|selectattr('status', 'equalto', 'licensed')|list|length > 0 %}
                                {% if not is_licensed %}
                                <div class="goal-display">
                                    <div class="goal-state">{{ goal_state }}</div>
                                    <div class="goal-label text-muted small">Target State</div>
                                </div>
                                {% else %}
                                <div class="text-success small">
                                    ‚úì Goal achieved! {{ holder.name }} is now licensed in {{ goal_state }}.
                                    <button class="btn btn-sm btn-link p-0" onclick="clearGoal()">Clear Goal</button>
                                </div>
                                {% endif %}
                            {% else %}
                            <p class="text-muted small mb-0">No goal set. Assign a target state for this license holder to pursue next.</p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Right: License Table (NetSuite Style) -->
                    <div class="col-lg-9">
                        <div class="netsuite-table-card">
                            <table class="table table-sm table-hover netsuite-table">
                                <thead>
                                    <tr>
                                        {% if is_director %}<th>Holder</th>{% endif %}
                                        <th>State</th>
                                        <th>Status</th>
                                        <th>License #</th>
                                        <th>Issued</th>
                                        <th>Expires</th>
                                        <th>Days Left</th>
                                        <th style="width: 140px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for license in licenses %}
                                    <tr class="license-row-{{ license.status }}">
                                        {% if is_director %}
                                        <td class="text-muted small">{{ license.holder_name }}</td>
                                        {% endif %}
                                        <td class="fw-semibold">
                                            {{ license.jurisdiction }}
                                            <span class="text-muted ms-1">({{ license.jurisdiction_abbr }})</span>
                                            {% if license.license_type %}
                                            <br><small class="text-muted">{{ license.license_type }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if license.status == 'licensed' %}
                                            <span class="status-badge status-licensed">‚óè Licensed</span>
                                            {% elif license.status == 'in_progress' %}
                                            <span class="status-badge status-progress">‚óè In Progress</span>
                                            {% elif license.status == 'overdue' %}
                                            <span class="status-badge status-overdue">‚óè Overdue</span>
                                            {% else %}
                                            <span class="status-badge status-none">‚óã Not Licensed</span>
                                            {% endif %}
                                        </td>
                                        <td><code class="license-number">{{ license.license_number or '‚Äî' }}</code></td>
                                        <td class="text-muted">{{ license.issued_on or '‚Äî' }}</td>
                                        <td class="text-muted">{{ license.expires_on or '‚Äî' }}</td>
                                        <td>
                                            {% if license.days_remaining is not none %}
                                            <span class="days-remaining">{{ license.days_remaining }} days</span>
                                            {% else %}
                                            ‚Äî
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="/settings/edit-license/{{ license.license_id }}" class="btn-table-action">Edit</a>
                                            <a href="/settings/cost-details/{{ license.license_id }}" class="btn-table-action text-success">üí∞ Costs</a>
                                            <button onclick="confirmDelete('{{ license.license_id }}', '{{ license.jurisdiction }}')" class="btn-table-action text-danger" style="border: none; background: none; cursor: pointer;">üóëÔ∏è Delete</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Set Goal Modal -->
<div class="modal fade" id="setGoalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set Next License Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/team/set-goal/{{ holder.user_id }}">
                <div class="modal-body">
                    <p class="text-muted small">Choose the next state for <strong>{{ holder.name }}</strong> to pursue a license in.</p>
                    <div class="mb-3">
                        <label class="form-label">Target State</label>
                        <select class="form-select" name="target_state" required>
                            <option value="">Select a state...</option>
                            {% set licensed_states = licenses|selectattr('status', 'equalto', 'licensed')|map(attribute='jurisdiction_abbr')|list %}
                            {% for abbr in ['AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA', 'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD', 'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ', 'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC', 'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'] %}
                            {% if abbr not in licensed_states %}
                            <option value="{{ abbr }}" {% if holder.next_target_state == abbr %}selected{% endif %}>
                                {{ abbr }}
                            </option>
                            {% endif %}
                            {% endfor %}
                        </select>
                        <small class="text-muted">Only showing states where not yet licensed</small>
                    </div>
                </div>
                <div class="modal-footer">
                    {% if holder.next_target_state %}
                    <button type="button" class="btn btn-outline-danger" onclick="clearGoal()">Clear Goal</button>
                    {% endif %}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Goal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.goal-display {
    text-align: center;
    padding: 1rem;
    background: #f0f9ff;
    border: 2px solid #3b82f6;
    border-radius: 8px;
}

.goal-state {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e40af;
    font-family: 'Courier New', monospace;
}

.goal-label {
    margin-top: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
</style>

<script>
function clearGoal() {
    if (confirm('Clear the license goal for {{ holder.name }}?')) {
        fetch('/team/clear-goal/{{ holder.user_id }}', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error clearing goal');
            }
        });
    }
}
</script>


<script>
function confirmDelete(licenseId, jurisdiction) {
    if (confirm(`Are you sure you want to delete the ${jurisdiction} license (${licenseId})? This cannot be undone.`)) {
        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/settings/delete-license/' + licenseId;
        
        // Add CSRF token if needed
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'csrf_token';
            input.value = csrfToken.content;
            form.appendChild(input);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>

{% endblock %}
